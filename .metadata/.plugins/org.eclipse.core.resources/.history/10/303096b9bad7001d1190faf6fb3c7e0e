#pragma once

#include "DataStructures/RingBuffer.hpp"
#include "Filters/MovingAverage.hpp"
#include "stm32h7xx_hal.h"
#include "Models/Pin.hpp"
#include <vector>
#include <cmath>

using namespace std;

class InputCapture {
private:
	static const uint32_t TIMER_CLOK_FREQ = 277777777;
	static const uint32_t MOVING_AVERAGE_SIZE = 3;
	MovingAverage<MOVING_AVERAGE_SIZE, double> DutyAverage;
	MovingAverage<MOVING_AVERAGE_SIZE, double> FrequencyAverage;
	int rising_edge = -1, falling_edge = -1;

	uint32_t absolute_difference(uint32_t a, uint32_t b);
	double interrupt();
	bool channel_is_active();

public:
	static vector<InputCapture*> all_input_captures;
	TIM_HandleTypeDef* timer;
	uint32_t channel;
	Pin pin;

	double frequency, duty;
	uint32_t frequency_i, duty_i;

	InputCapture(TIM_HandleTypeDef* timer, uint32_t channel, Pin pin);
	static void start_all_input_captures();
	static void interrupt_of_all_input_captures(TIM_HandleTypeDef* timer);
	void start();
	void stop();
	void reset();
};



enum PinMode {
	NONE,
	AnalogInput,
	AnalogOutput,
	InputCapture,
	DigitalOutput,
	DigitalInput
};

class Pin {
public:
	Pin(GPIO_TypeDef* port, uint16_t pin) : port(port), pin(pin) {  }
	GPIO_TypeDef* port;
	uint16_t pin;
	PinMode mode;
};

Pin PA0(GPIOA, GPIO_PIN_0);
Pin PA1(GPIOA, GPIO_PIN_1);
Pin PA2(GPIOA, GPIO_PIN_2);
Pin PA3(GPIOA, GPIO_PIN_3);
Pin PA4(GPIOA, GPIO_PIN_4);
Pin PA5(GPIOA, GPIO_PIN_5);
Pin PA6(GPIOA, GPIO_PIN_6);
Pin PA7(GPIOA, GPIO_PIN_7);
Pin PA8(GPIOA, GPIO_PIN_8);
Pin PA9(GPIOA, GPIO_PIN_9);
Pin PA10(GPIOA, GPIO_PIN_10);
Pin PA11(GPIOA, GPIO_PIN_11);
Pin PA12(GPIOA, GPIO_PIN_12);
Pin PA13(GPIOA, GPIO_PIN_13);
Pin PA14(GPIOA, GPIO_PIN_14);
Pin PA15(GPIOA, GPIO_PIN_15);

Pin PB0(GPIOB, GPIO_PIN_0);
Pin PB1(GPIOB, GPIO_PIN_1);
Pin PB2(GPIOB, GPIO_PIN_2);
Pin PB3(GPIOB, GPIO_PIN_3);
Pin PB4(GPIOB, GPIO_PIN_4);
Pin PB5(GPIOB, GPIO_PIN_5);
Pin PB6(GPIOB, GPIO_PIN_6);
Pin PB7(GPIOB, GPIO_PIN_7);
Pin PB8(GPIOB, GPIO_PIN_8);
Pin PB9(GPIOB, GPIO_PIN_9);
Pin PB10(GPIOB, GPIO_PIN_10);
Pin PB11(GPIOB, GPIO_PIN_11);
Pin PB12(GPIOB, GPIO_PIN_12);
Pin PB13(GPIOB, GPIO_PIN_13);
Pin PB14(GPIOB, GPIO_PIN_14);
Pin PB15(GPIOB, GPIO_PIN_15);


Pin PD0(GPIOD, GPIO_PIN_0);
Pin PD1(GPIOD, GPIO_PIN_1);
Pin PD2(GPIOD, GPIO_PIN_2);
Pin PD3(GPIOD, GPIO_PIN_3);
Pin PD4(GPIOD, GPIO_PIN_4);
Pin PD5(GPIOD, GPIO_PIN_5);
Pin PD6(GPIOD, GPIO_PIN_6);
Pin PD7(GPIOD, GPIO_PIN_7);
Pin PD8(GPIOD, GPIO_PIN_8);
Pin PD9(GPIOD, GPIO_PIN_9);
Pin PD10(GPIOD, GPIO_PIN_10);
Pin PD11(GPIOD, GPIO_PIN_11);
Pin PD12(GPIOD, GPIO_PIN_12);
Pin PD13(GPIOD, GPIO_PIN_13);
Pin PD14(GPIOD, GPIO_PIN_14);
Pin PD15(GPIOD, GPIO_PIN_15);

Pin PE0(GPIOE, GPIO_PIN_0);
Pin PE1(GPIOE, GPIO_PIN_1);
Pin PE2(GPIOE, GPIO_PIN_2);
Pin PE3(GPIOE, GPIO_PIN_3);
Pin PE4(GPIOE, GPIO_PIN_4);
Pin PE5(GPIOE, GPIO_PIN_5);
Pin PE6(GPIOE, GPIO_PIN_6);
Pin PE7(GPIOE, GPIO_PIN_7);
Pin PE8(GPIOE, GPIO_PIN_8);
Pin PE9(GPIOE, GPIO_PIN_9);
Pin PE10(GPIOE, GPIO_PIN_10);
Pin PE11(GPIOE, GPIO_PIN_11);
Pin PE12(GPIOE, GPIO_PIN_12);
Pin PE13(GPIOE, GPIO_PIN_13);
Pin PE14(GPIOE, GPIO_PIN_14);
Pin PE15(GPIOE, GPIO_PIN_15);

Pin PF0(GPIOF, GPIO_PIN_0);
Pin PF1(GPIOF, GPIO_PIN_1);
Pin PF2(GPIOF, GPIO_PIN_2);
Pin PF3(GPIOF, GPIO_PIN_3);
Pin PF4(GPIOF, GPIO_PIN_4);
Pin PF5(GPIOF, GPIO_PIN_5);
Pin PF6(GPIOF, GPIO_PIN_6);
Pin PF7(GPIOF, GPIO_PIN_7);
Pin PF8(GPIOF, GPIO_PIN_8);
Pin PF9(GPIOF, GPIO_PIN_9);
Pin PF10(GPIOF, GPIO_PIN_10);
Pin PF11(GPIOF, GPIO_PIN_11);
Pin PF12(GPIOF, GPIO_PIN_12);
Pin PF13(GPIOF, GPIO_PIN_13);
Pin PF14(GPIOF, GPIO_PIN_14);
Pin PF15(GPIOF, GPIO_PIN_15);


